# Retrofagia ‚Äî Backend MVP

Colecionador de vinis com feed social, avalia√ß√µes e DMs. Este README descreve **o que j√° foi constru√≠do**, como **rodar/testar** e os **pr√≥ximos passos** (com checklists).

---

## üîß Stack & Arquitetura

* **API**: FastAPI (Python 3.12)
* **Auth**: JWT (python-jose) + senhas com Passlib/bcrypt

  > üîá Para silenciar warnings do passlib com bcrypt, estamos usando `bcrypt==3.2.2`.
* **ORM**: SQLAlchemy **2.x**
* **DB**: PostgreSQL 16
* **Migra√ß√µes**: Alembic
* **Container**: Docker + Docker Compose
* **Pydantic**: v2 (schemas com `ConfigDict(from_attributes=True)`)

**Diret√≥rios principais (sugest√£o):**

```
retrofagia/
‚îú‚îÄ backend/
‚îÇ  ‚îú‚îÄ app/
‚îÇ  ‚îÇ  ‚îú‚îÄ main.py                 # app FastAPI + CORS + include_routers
‚îÇ  ‚îÇ  ‚îú‚îÄ db.py                   # SessionLocal, engine, Base
‚îÇ  ‚îÇ  ‚îú‚îÄ config.py               # settings (.env)
‚îÇ  ‚îÇ  ‚îú‚îÄ deps.py                 # get_current_user (JWT)
‚îÇ  ‚îÇ  ‚îú‚îÄ models.py               # modelos SQLAlchemy (Users, Records, etc.)
‚îÇ  ‚îÇ  ‚îú‚îÄ schemas.py              # Pydantic v2 (UUID/datetime)
‚îÇ  ‚îÇ  ‚îú‚îÄ activity.py             # create_activity(...)
‚îÇ  ‚îÇ  ‚îî‚îÄ routers/
‚îÇ  ‚îÇ     ‚îú‚îÄ auth.py
‚îÇ  ‚îÇ     ‚îú‚îÄ records.py
‚îÇ  ‚îÇ     ‚îú‚îÄ collection.py
‚îÇ  ‚îÇ     ‚îú‚îÄ reviews.py
‚îÇ  ‚îÇ     ‚îú‚îÄ comments.py          # coment√°rios em discos
‚îÇ  ‚îÇ     ‚îú‚îÄ feed.py              # feed + likes + coment√°rios na activity
‚îÇ  ‚îÇ     ‚îú‚îÄ follows.py           # follow/unfollow (204)
‚îÇ  ‚îÇ     ‚îî‚îÄ conversations.py     # DMs (1:1)
‚îÇ  ‚îú‚îÄ alembic/ ...               # migra√ß√µes
‚îÇ  ‚îú‚îÄ requirements.txt
‚îÇ  ‚îú‚îÄ Dockerfile
‚îÇ  ‚îú‚îÄ tests_retrofagia.sh        # script de testes E2E (curl + jq)
‚îÇ  ‚îî‚îÄ Makefile                   # up/build/logs/test
‚îú‚îÄ docker-compose.yaml
‚îî‚îÄ (frontend/ - a ser criado)
```

---

## ‚úÖ Funcionalidades j√° implementadas

### Usu√°rios & Autentica√ß√£o

* [x] Registro `/auth/register` (400 se username/email j√° usados)
* [x] Login `/auth/login` ‚Üí `access_token` (JWT)
* [x] Perfil atual `/auth/me`

### Discos & Cole√ß√£o

* [x] Cadastro de disco `/records` (unique por `matrix_code`)
* [x] Busca de discos por `code`, `q`(titulo/artista), `artist`, `year`, `genre`, `label`
* [x] Adicionar √† cole√ß√£o `/collection/{record_id}`
* [x] Favoritar na cole√ß√£o `PATCH /collection/{record_id} {"is_favorite": true}`
* [x] Listar favoritos `/collection/me/favorites`

### Avalia√ß√µes & Coment√°rios

* [x] Review com nota/coment√°rio `POST /reviews` (upsert por user+record)
* [x] Coment√°rios em disco `POST/GET /records/{id}/comments`

### Social (seguidores) & Feed

* [x] Seguir usu√°rio `POST /users/{user_id}/follow` (204)
* [x] Feed dos seguidos `/feed?limit=...` (ordem cronol√≥gica inversa)
* [x] Atividades no feed: ADD\_RECORD, REVIEW, COMMENT
* [x] Like de atividade `POST/DELETE /feed/{activity_id}/like`
* [x] Coment√°rios em atividade `POST/GET /feed/{activity_id}/comments`

### Mensagens privadas (DMs)

* [x] Criar conversa 1:1 `POST /conversations { other_user_id }`
* [x] Enviar mensagem `POST /conversations/{conversation_id}/messages`
* [x] Listar hist√≥rico `GET /conversations/{conversation_id}/messages`

---

## ‚ñ∂Ô∏è Como rodar

Pr√©-requisitos: **Docker**, **Docker Compose**, `curl`, `jq` e (opcional) `make`.

```bash
# subir servi√ßos
docker compose up -d --build

# ver logs
docker compose logs -f backend
```

Vari√°veis de ambiente (sugest√£o de chaves em `.env` usadas no backend):

```
DATABASE_URL=postgresql+psycopg://retrofagia:retrofagia@db:5432/retrofagia
JWT_SECRET=troque-por-uma-chave-segura
JWT_ALG=HS256
```

> **Migrations**: se necess√°rio, rode `alembic upgrade head` dentro do container backend; mas o projeto j√° vem com as tabelas criadas/testadas.

---

## üß™ Testes E2E (script)

Usamos um script bash que valida o fluxo **end-to-end** (auth, discos, cole√ß√£o, reviews, feed, follow, coment√°rios, favoritos, likes, DMs).

```bash
cd backend
chmod +x tests_retrofagia.sh

# direto
./tests_retrofagia.sh

# ou via make
make up && make build && make test
```

Sa√≠da esperada (resumo):

```
üéâ TODOS OS TESTES PASSARAM!
```

---

## üîå Endpoints (cheat sheet)

**Auth**

* `POST /auth/register` ‚Üí `{ access_token }`
* `POST /auth/login` ‚Üí `{ access_token }`
* `GET /auth/me` ‚Üí `{ id, username, email }`

**Discos**

* `POST /records` ‚Üí cria (unique `matrix_code`)
* `GET /records?code=...&q=...&artist=...&year=...&genre=...&label=...` ‚Üí lista

**Cole√ß√£o**

* `POST /collection/{record_id}` ‚Üí adiciona
* `PATCH /collection/{record_id}` `{ "is_favorite": true }`
* `GET /collection/me/favorites` ‚Üí lista de `Record`

**Reviews & Coment√°rios**

* `POST /reviews` `{ record_id, rating, comment? }` ‚Üí upsert por user+record
* `POST /records/{record_id}/comments` `{ content }`
* `GET  /records/{record_id}/comments`

**Social & Feed**

* `POST /users/{user_id}/follow` ‚Üí 204
* `GET  /feed?limit=20` ‚Üí atividades dos seguidos (e do pr√≥prio)
* `POST /feed/{activity_id}/like` ‚Üí 204
* `DELETE /feed/{activity_id}/like` ‚Üí 204
* `POST /feed/{activity_id}/comments` `{ content }`
* `GET  /feed/{activity_id}/comments`

**DMs**

* `POST /conversations` `{ other_user_id }`
* `POST /conversations/{conversation_id}/messages` `{ content }`
* `GET  /conversations/{conversation_id}/messages`

---

## ü©π Troubleshooting (erros comuns que j√° resolvemos)

* **SQLAlchemy 2.x**: n√£o use `Model.id.cast(str)`.
  ‚úÖ Use `from sqlalchemy import cast, String` e compare assim: `cast(Model.id, String) == some_id_str`.

* **UUID vs String no Postgres**: evite `cast(..., String)` quando a coluna √© UUID.
  ‚úÖ Tipar o par√¢metro de rota como `UUID` e comparar `UUID == UUID` (ex.: DMs `conversation_id: UUID`).

* **Pydantic v2**: tipos corretos nas responses.
  ‚úÖ Campos `id`, `user_id`, `record_id` como `UUID`; `created_at` como `datetime`.
  ‚úÖ `model_config = ConfigDict(from_attributes=True)`.

* **Passlib + bcrypt 4.x**: ‚Äú(trapped) error reading bcrypt version‚Äù.
  ‚úÖ Fix com `bcrypt==3.2.2` em `requirements.txt`.

---

## üìà √çndices recomendados (Alembic)

Para performance (opcional, mas sugerido):

* `records(matrix_code)` (unique)
* `records(title, artist)`
* `user_collection(user_id)`
* `reviews(user_id, record_id)` (unique)
* `follows(follower_id)`
* `activity(actor_id, created_at)`

> Crie uma revis√£o Alembic `add indexes` e aplique.

---

## üó∫Ô∏è Roadmap (pr√≥ximos passos)

### Frontend (React + Vite + TS + Tailwind + React Query)

* [ ] Setup do projeto (`frontend/`) + CORS no backend
* [ ] P√°gina **Login** (persist√™ncia do token + `/auth/me`)
* [ ] P√°gina **Feed** (listar; like/comentar activity)
* [ ] P√°gina **Busca/Explorar** (filtros por ano/g√™nero/gravadora)
* [ ] P√°gina **Detalhe do Disco** (adicionar √† cole√ß√£o, favoritar, avaliar, comentar, ver reviews)
* [ ] P√°gina **Minha Cole√ß√£o** / **Favoritos**
* [ ] **Perfil do Usu√°rio** (seguir/unfollow, ver cole√ß√£o/avalia√ß√µes)
* [ ] **DMs** (lista de conversas + chat em tempo real depois com WS)
* [ ] UX: toasts, loading states, pagina√ß√£o (cursor no feed), vazio/erros

### Backend (evolu√ß√µes)

* [ ] Pagina√ß√£o com cursor em `/feed`, `/records`, etc.
* [ ] Valida√ß√µes (ex.: `rating` entre 0‚Äì10, tamanho de conte√∫do)
* [ ] Uniqueness e constraints robustas (follow √∫nico, conversa 1:1 √∫nica por par)
* [ ] WebSockets para **DMs** e (talvez) feed ao vivo
* [ ] Notifica√ß√µes (ex.: novo seguidor, novo coment√°rio)
* [ ] Upload/armazenamento de capas (opcional, S3/minio)
* [ ] Logs estruturados (JSON) + correla√ß√£o de request
* [ ] Seeds de dados para dev (`db/seed.sql`)
* [ ] Healthchecks e m√©tricas (Prometheus/OTel)

### Qualidade & DevOps

* [ ] **pre-commit** (black, ruff) configurado
* [ ] **pytest** com testes de integra√ß√£o (substituir/acompanhar o script bash)
* [ ] **CI** (GitHub Actions): lint, build, testes com servi√ßo Postgres
* [ ] **CD** (deploy container em staging/prod)
* [ ] Ambiente `.env` separado por stage + `pydantic-settings`

---

## üß≠ TL;DR (dev loop)

```bash
# subir
docker compose up -d --build

# testar E2E
cd backend
make test

# logs
docker compose logs -f backend
```
