{% extends "base.html" %}
{% block title %}Review · {{ review.album.title }}{% endblock %}
{% block content %}
<section class="card review-card review-focus">
  <div class="review-detail-nav">
    <a class="button ghost" href="{{ url_for('main.feed') }}">← Voltar ao feed</a>
    <a class="button ghost" href="{{ url_for('main.album_detail', album_id=review.album.id) }}">Ver álbum</a>
  </div>
  <header class="review-header">
    <div class="review-user">
      <a href="{{ url_for('main.view_profile', username=review.user.username) }}">
        {% if review.user.avatar_url %}
        <img src="{{ review.user.avatar_url | image_url }}" alt="Avatar de {{ review.user.username }}" />
        {% else %}
        <div class="avatar-placeholder">{{ review.user.username[0]|upper }}</div>
        {% endif %}
        <span>{{ review.user.username }}</span>
      </a>
    </div>
    <span class="review-rating" aria-label="Avaliação: {{ review.rating }} de 5">
      {% for _ in range(review.rating) %}<span>&#9733;</span>{% endfor %}
      {% for _ in range(5 - review.rating) %}<span class="muted">&#9733;</span>{% endfor %}
    </span>
  </header>
  <div class="review-album">
    {% if review.album.cover_url %}
    <img src="{{ review.album.cover_url | image_url }}" alt="Capa do álbum {{ review.album.title }}" />
    {% endif %}
    <div>
      <h3>{{ review.album.title }}</h3>
      <p class="muted">{{ review.album.artist }}</p>
    </div>
  </div>
  <p class="review-content">{{ review.content }}</p>
  <footer class="review-footer">
    <span class="muted">{{ review.created_at.strftime('%d/%m/%Y %H:%M') }}</span>
    <div class="review-actions">
      <a class="button ghost" href="{{ url_for('main.album_detail', album_id=review.album.id) }}">Ver álbum</a>
      {% if review.user_id == current_user.id %}
      <a class="button ghost" href="{{ url_for('main.edit_review', review_id=review.id) }}">Editar</a>
      <form method="post" action="{{ url_for('main.delete_review', review_id=review.id) }}">
        <button type="submit" class="ghost danger">Excluir</button>
      </form>
      {% endif %}
    </div>
  </footer>

  <section class="comments">
    <h4>Todos os comentários ({{ review.comments|length }})</h4>
    <div class="comments-list">
      {% for comment in review.comments %}
      <div class="comment">
        <div class="comment-meta">
          <a href="{{ url_for('main.view_profile', username=comment.user.username) }}">{{ comment.user.username }}</a>
          <span class="timestamp">{{ comment.created_at.strftime('%d/%m %H:%M') }}</span>
        </div>
        <p>{{ comment.content }}</p>
      </div>
      {% else %}
      <p class="muted">Seja o primeiro a comentar.</p>
      {% endfor %}
    </div>
    <form method="post" action="{{ url_for('main.add_comment', review_id=review.id) }}" class="form inline-comment">
      <textarea name="content" rows="2" placeholder="Escreva um comentário..." required></textarea>
      <button type="submit">Enviar</button>
    </form>
  </section>
</section>
{% endblock %}
