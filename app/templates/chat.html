{% extends "base.html" %}
{% block title %}Chats · retrofagia{% endblock %}
{% set unread_counts = unread_counts or {} %}
{% block content %}
<section
  class="chat-layout {% if selected_user %}chat-layout-thread-only{% else %}chat-layout-contacts-only{% endif %}"
>
  {% if not selected_user %}
  <aside class="chat-sidebar chat-sidebar-expanded">
    <div class="chat-sidebar-bar">
      <h2>Conversas</h2>
    </div>
    <div class="chat-sidebar-scroll">
      <ul>
        {% for contact in contacts %}
        <li>
          {% set unread = unread_counts.get(contact.id, 0) %}
          <a href="{{ url_for('main.chat', with_user=contact.id) }}">
            {% if contact.avatar_url %}
            <img src="{{ contact.avatar_url | image_url }}" alt="Avatar de {{ contact.username }}" />
            {% else %}
            <div class="avatar-placeholder">{{ contact.username[0]|upper }}</div>
            {% endif %}
            <span class="chat-contact-name">{{ contact.username }}</span>
            {% if unread %}
            <span class="chat-unread-badge" aria-label="{{ unread }} mensagens não lidas">
              {{ unread if unread < 100 else "99+" }}
            </span>
            {% endif %}
          </a>
        </li>
        {% else %}
        <li class="muted">Sem contatos ainda. Siga pessoas para começar.</li>
        {% endfor %}
      </ul>
    </div>
  </aside>
  {% else %}
  <div
    class="chat-thread"
    data-chat-thread
    data-selected-user-id="{{ selected_user.id }}"
    {% if conversation %}
    data-last-message-id="{{ (conversation|last).id }}"
    {% endif %}
  >
    <header class="chat-header">
      <a href="{{ url_for('main.chat') }}" class="chat-back" aria-label="Voltar para contatos">
        <span aria-hidden="true">←</span>
        <span>Conversas</span>
      </a>
      <h2>{{ selected_user.username }}</h2>
    </header>
    <div class="chat-messages" data-chat-messages>
      {% for message in conversation %}
      <div
        class="message {% if message.sender_id == current_user.id %}from-me{% else %}from-them{% endif %}"
        data-message-id="{{ message.id }}"
      >
        <p>{{ message.content }}</p>
        <span class="timestamp">{{ message.created_at.strftime('%d/%m %H:%M') }}</span>
      </div>
      {% else %}
      <p class="muted">Nenhuma mensagem ainda. Envie a primeira!</p>
      {% endfor %}
    </div>
    <form method="post" class="form chat-form">
      <input type="hidden" name="recipient_id" value="{{ selected_user.id }}" />
      <textarea name="content" rows="2" placeholder="Digite sua mensagem..." required></textarea>
      <button type="submit">Enviar</button>
    </form>
  </div>
  {% endif %}
</section>
{% endblock %}
